default:
  interruptible: true
  image: node:20-alpine

stages:
  - build
  - test

# ----------------------- BUILD ---------------------------------- #
build:
  stage: build
  script:
    - echo "Building bandit-frontend project"
    - npm ci
    - npm run build
  rules:
    - if: $CI_PIPELINE_SOURCE == 'merge_request_event'
    - if: $CI_COMMIT_TAG
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH || $CI_COMMIT_BRANCH == 'ci-cd/dev'

# ----------------------- TEST ---------------------------------- #
eslint:
  stage: test
  script:
    - echo "Running ESLint"
    - npm ci
    - npm run lint
  rules:
    - if: $CI_PIPELINE_SOURCE == 'merge_request_event'
    - if: $CI_COMMIT_TAG
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH || $CI_COMMIT_BRANCH == 'ci-cd/dev'
  allow_failure: false


sast:
  stage: test
  script:
    - echo "Running SAST with dependency-check or another tool"
    - npx snyk code --severity-threshold=medium
  rules:
    - if: $CI_PIPELINE_SOURCE == 'merge_request_event'
    - if: $CI_COMMIT_TAG
    - if: $CI_COMMIT_BRANCH == $CI_DEFAULT_BRANCH || $CI_COMMIT_BRANCH == 'ci-cd/dev'
  allow_failure: false



# ----------------------- DEPLOY ---------------------------------- #
#deploy:
#  stage: deploy
#  script:
#    - echo "Deploying project to development environment..."
#    # Add deployment script/commands here
#  rules:
#    - if: $CI_COMMIT_BRANCH == 'ci-cd/dev'
#  environment:
#    name: development
#    url:

# ----------------------- DESTROY ---------------------------------- #
#destroy:
#  stage: destroy
#  script:
#    - echo "Cleaning up resources in development..."
#  rules:
#    - if: $CI_COMMIT_BRANCH != $CI_DEFAULT_BRANCH
#    - if: $CI_COMMIT_BRANCH == 'ci-cd'
